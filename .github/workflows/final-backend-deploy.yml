name: Deploy Backend Ktor to EC2

on:
  push:
    branches:
      - develop-Backend
      - main
      - master
  
  # ðŸš¨ Â¡AÃ±adir esta lÃ­nea para forzar la lectura y permitir ejecuciÃ³n manual! ðŸš¨
  workflow_dispatch: 

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:

      # 1. Descargar el cÃ³digo del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Dar permisos de ejecuciÃ³n a Gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        working-directory: Gradix

      # 4. Construir el Fat JAR
      - name: Build with Gradle
        run: ./gradlew clean shadowJar
        working-directory: Gradix

      # 5. Crear el archivo de llave SSH temporal
      - name: Create SSH Key File
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # 6. Desplegar a EC2 (Subir archivo + Reiniciar servicio)
      - name: Deploy to EC2 via SSH
        run: |
          scp -o StrictHostKeyChecking=no -i private_key.pem Gradix/build/libs/api-all.jar ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/api-all.jar
          ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl restart ktor-backend && sudo systemctl status ktor-backend"