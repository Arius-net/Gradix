name: Deploy Backend Ktor to EC2

on:
  push:
    branches:
      # *** IMPORTANTE: Asegúrate que esta lista incluya la rama donde subirás este archivo ***
      - develop-Backend
      - main
      - master


jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:

      # 1. Descargar el código del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar Java 21 (Necesario para compilar tu Ktor/Gradle)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Dar permisos de ejecución a Gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Construir el Fat JAR
      - name: Build with Gradle
        run: ./gradlew clean shadowJar

      # 5. Crear el archivo de llave SSH temporal
      - name: Create SSH Key File
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # 6. Desplegar a EC2 (Subir archivo + Reiniciar servicio)
      - name: Deploy to EC2 via SSH
        run: |
          # A. Subir el nuevo .jar: Fuente (api-all.jar) va a Destino (/home/ec2-user/api-all.jar)
          # Esto coincide con lo que tu servicio Systemd está configurado para ejecutar.
          scp -o StrictHostKeyChecking=no -i private_key.pem build/libs/api-all.jar ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/api-all.jar

          # B. Reiniciar el servicio: Usamos el servicio confirmado 'ktor-backend'
          ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl restart ktor-backend.service && sudo systemctl status ktor-backend.service"